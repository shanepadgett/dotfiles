# --- Completion system ----
autoload -Uz compinit
compinit -C

COLORTERM=truecolor

BREW_PREFIX=$(brew --prefix 2>/dev/null)
[[ -n "$BREW_PREFIX" ]] && source "$BREW_PREFIX/share/zsh-autosuggestions/zsh-autosuggestions.zsh"

# Homebrew completions
if [[ -n "$BREW_PREFIX" && -d "$BREW_PREFIX/share/zsh/site-functions" ]]; then
  fpath=("$BREW_PREFIX/share/zsh/site-functions" $fpath)
fi

# Add deno completions to search path
if [[ ":$FPATH:" != *":$HOME/.zsh/completions:"* ]]; then export FPATH="$HOME/.zsh/completions:$FPATH"; fi

# Exports
export PATH="$HOME/.local/bin:$PATH"
export BUN_INSTALL="$HOME/.bun"
export PATH="$HOME/.opencode/bin:$PATH"
export PATH="$BUN_INSTALL/bin:$PATH"
export EDITOR="zed --wait"
export GITHUB_USERNAME="shanepadgett"
export DEV_PATH="$HOME/dev"
export DO_NOT_TRACK=1

# Load custom aliases
[ -f "$HOME/.aliases.zsh" ] && source "$HOME/.aliases.zsh"

# --- Inits (Must remain at the end) ---
eval "$(zoxide init zsh)"
# Lazy-load starship prompt (runs at first prompt render)
autoload -Uz add-zsh-hook
_starship_init_once() {
  add-zsh-hook -d precmd _starship_init_once
  eval "$(starship init zsh)"
}
add-zsh-hook precmd _starship_init_once

# Lazy-load mise (activates on first use of runtimes)
_mise_activate_once() {
  unfunction _mise_activate_once 2>/dev/null || true
  eval "$(command mise activate zsh)"
}

# Some of these (node/bun/deno/go) are aliases in `~/.aliases.zsh`.
# Functions can't be defined over an existing alias, so remove aliases first.
unsetopt aliases 2>/dev/null || true
unalias node npm npx bun deno go mise 2>/dev/null || true
setopt aliases 2>/dev/null || true

mise() { _mise_activate_once; unfunction mise 2>/dev/null || true; command mise "$@"; }
node() { _mise_activate_once; unfunction node 2>/dev/null || true; command node "$@"; }
npm() { _mise_activate_once; unfunction npm 2>/dev/null || true; command npm "$@"; }
npx() { _mise_activate_once; unfunction npx 2>/dev/null || true; command npx "$@"; }
bun() { _mise_activate_once; unfunction bun 2>/dev/null || true; command bun "$@"; }
deno() { _mise_activate_once; unfunction deno 2>/dev/null || true; command deno "$@"; }
go() { _mise_activate_once; unfunction go 2>/dev/null || true; command go "$@"; }
# Initialize fzf (enables Ctrl+R history search and Tab completion)
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh
[[ -n "$BREW_PREFIX" ]] && source "$BREW_PREFIX/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
